@echo off
chcp 65001 >nul
echo ====================================================
echo        –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –°–ï–†–í–ï–†–û–í 5001 -> DOCKER
echo ====================================================
echo.

cd /d "%~dp0"

echo üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤...
docker ps | findstr pccon_web >nul
if errorlevel 1 (
    echo.
    echo ‚ùå Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä pccon_web –Ω–µ –∑–∞–ø—É—â–µ–Ω!
    echo.
    echo üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã...
    cd ..
    docker-compose up -d
    if errorlevel 1 (
        echo ‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ Docker!
        pause
        exit /b 1
    )
    echo ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
    echo ‚è≥ –ñ–¥–µ–º 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...
    timeout /t 10 /nobreak >nul
    cd local_parser
) else (
    echo ‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä pccon_web –∑–∞–ø—É—â–µ–Ω
)

echo.
echo üîç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö URL —Å–µ—Ä–≤–µ—Ä–æ–≤...

:: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä 5001
echo   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ 5001...
python sync_servers.py --source-url http://127.0.0.1:5001 --target-url http://127.0.0.1:5000 --test-only
if errorlevel 1 (
    echo.
    echo ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞–º–∏!
    echo.
    echo üîß –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:
    echo    1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä: cd .. ^&^& python run.py
    echo    2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Docker: docker-compose ps
    echo.
    pause
    exit /b 1
)

echo.
echo ‚úÖ –°–µ—Ä–≤–µ—Ä—ã –¥–æ—Å—Ç—É–ø–Ω—ã!
echo.

echo üìä –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–∞–Ω–Ω—ã—Ö...
python sync_servers.py --source-url http://127.0.0.1:5001 --target-url http://127.0.0.1:5000 --info
echo.

echo üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö...
echo    –ò–ó: 127.0.0.1:5001 (–ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)
echo    –í:  127.0.0.1:5000 (Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä pccon_web)
echo ====================================================

python sync_servers.py --source-url http://127.0.0.1:5001 --target-url http://127.0.0.1:5000 --sync

if errorlevel 1 (
    echo.
    echo ‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏!
    echo üìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
    pause
    exit /b 1
)

echo.
echo ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!
echo.

echo üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...
echo ====================================================
python check_server_data.py

echo.
echo üåê –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Docker —Å–µ—Ä–≤–µ—Ä–∞: http://127.0.0.1:5000
echo üìä API —Å—Ç–∞—Ç—É—Å: http://127.0.0.1:5000/api/parser-status
echo.
echo üéâ –ì–æ—Ç–æ–≤–æ! –î–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
pause 